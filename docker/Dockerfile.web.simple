# Simple web server with static files
FROM golang:1.21-alpine AS builder

WORKDIR /build

# Copy server code
COPY web/simple_server.go .

# Build static binary
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
    go build -ldflags="-w -s" -o server simple_server.go

# Final stage - minimal Alpine
FROM alpine:latest

# Install ca-certificates for HTTPS
RUN apk --no-cache add ca-certificates

WORKDIR /

# Copy binary
COPY --from=builder /build/server /server

# Create static directory and copy web files
RUN mkdir -p /static
COPY web/*.html /static/
COPY web/*.css /static/
COPY web/*.js /static/

EXPOSE 8001

# Run as non-root
RUN adduser -D -u 1000 webuser
USER webuser

CMD ["/server"]