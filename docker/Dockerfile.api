# Distroless Python for Agent Core API
FROM python:3.12-slim as builder

# Install build dependencies
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /build

# Copy and install requirements
COPY requirements.txt .
RUN pip install --no-cache-dir --target=/app/deps -r requirements.txt

# Compile Python files for faster startup
RUN python -m compileall -b /app/deps

# Final stage - slim Python (C extensions work)
FROM python:3.12-slim

WORKDIR /app

# Copy dependencies
COPY --from=builder /app/deps /app/deps

# Copy application code (pre-compile for performance)
COPY api/ ./api/
COPY agents/ ./agents/
COPY core/ ./core/
COPY utils/ ./utils/
COPY knowledge/ ./knowledge/
COPY mcp_servers/ ./mcp_servers/
COPY config/ ./config/

# Environment setup
ENV PYTHONPATH=/app/deps:/app:$PYTHONPATH
ENV PYTHONUNBUFFERED=1
ENV PYTHONOPTIMIZE=2
ENV PYTHONDONTWRITEBYTECODE=1

# Memory optimization
ENV MALLOC_TRIM_THRESHOLD_=100000
ENV MALLOC_MMAP_THRESHOLD_=100000

EXPOSE 8000

# Run LLM API with AI responses
ENTRYPOINT ["python3", "api/quick_api.py"]